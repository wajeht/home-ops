# Compose-mode deployer for apps/compose/ (plex, vpn-qbit)
# These apps need device access not supported by Swarm

services:
  doco-cd:
    image: ghcr.io/kimdre/doco-cd:0.61.0@sha256:f8968e5b1f51ca1893a8ea929b3bbf2e63992a1a8aa471362d27a78e85c286c1
    container_name: doco-cd-compose
    environment:
      TZ: America/Chicago
      LOG_LEVEL: info
      MAX_DEPLOYMENT_LOOP_COUNT: "3"
      DOCKER_SWARM_FEATURES: "false"
      SOPS_AGE_KEY_FILE: /sops/age-key.txt
      GIT_ACCESS_TOKEN: ${GH_TOKEN}
      WEBHOOK_SECRET: ${WEBHOOK_SECRET}
      POLL_CONFIG: |
        - url: https://github.com/wajeht/home-ops.git
          reference: refs/heads/main
          interval: 60
          deployments:
            - working_dir: apps/compose
              auto_discover: true
              auto_discover_opts:
                delete: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /home/jaw/data/doco-cd:/data
      - /home/jaw/.sops/age-key.txt:/sops/age-key.txt:ro
      - /home/jaw/.docker/config.json:/root/.docker/config.json:ro
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.doco-cd-compose.rule=Host(`doco-compose.jaw.dev`)"
      - "traefik.http.routers.doco-cd-compose.entrypoints=websecure"
      - "traefik.http.services.doco-cd-compose.loadbalancer.server.port=80"
    healthcheck:
      test: ["CMD", "/doco-cd", "healthcheck"]
      start_period: 15s
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

networks:
  traefik:
    external: true

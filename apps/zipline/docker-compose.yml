services:
  zipline:
    image: ghcr.io/diced/zipline:v4
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgres://zipline:${POSTGRES_PASSWORD}@zipline-db:5432/zipline
      - TZ=America/Chicago
    depends_on:
      zipline-db:
        condition: service_healthy
    volumes:
      - /home/jaw/data/zipline/uploads:/zipline/uploads
      - /home/jaw/data/zipline/public:/zipline/public
      - /home/jaw/data/zipline/themes:/zipline/themes
    networks:
      - traefik
      - zipline-internal
    healthcheck:
      test: ["CMD", "wget", "-O", "/dev/null", "-q", "http://0.0.0.0:3000"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.zipline.rule=Host(`img.jaw.dev`)"
      - "traefik.http.routers.zipline.entrypoints=websecure"
      - "traefik.http.routers.zipline.middlewares=auth-admin@file"
      - "traefik.http.services.zipline.loadbalancer.server.port=3000"
  zipline-db:
    image: postgres:17-alpine
    env_file:
      - .env
    environment:
      - POSTGRES_USER=zipline
      - POSTGRES_DB=zipline
      - PGDATA=/var/lib/postgresql/data
    volumes:
      - /home/jaw/data/zipline/db:/var/lib/postgresql/data
    networks:
      - zipline-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U zipline"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M

networks:
  traefik:
    external: true
  zipline-internal:

http:
  middlewares:
    redirect-to-main:
      redirectRegex:
        regex: ".*"
        replacement: "https://jaw.dev"
        permanent: true

    gzip:
      compress:
        excludedContentTypes:
          - image/png
          - image/jpeg
          - image/gif
          - image/webp

    security-headers:
      headers:
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
        forceSTSHeader: true
        contentTypeNosniff: true
        frameDeny: true
        referrerPolicy: "strict-origin-when-cross-origin"
        permissionsPolicy: "camera=(), microphone=(), geolocation=()"

    custom-errors:
      errors:
        status:
          - "500-599"
        service: dummy
        query: "/"

    rate-limit-global:
      rateLimit:
        period: 1s
        average: 200
        burst: 400
        sourceCriterion:
          ipStrategy:
            ipv6Subnet: 64

    rate-limit-auth:
      rateLimit:
        period: 1s
        average: 60
        burst: 120
        sourceCriterion:
          ipStrategy:
            ipv6Subnet: 64

    google-auth-user:
      forwardAuth:
        address: http://google-auth-user:4181
        trustForwardHeader: true
        authResponseHeaders:
          - X-Forwarded-User

    google-auth-admin:
      forwardAuth:
        address: http://google-auth-admin:4181
        trustForwardHeader: true
        authResponseHeaders:
          - X-Forwarded-User

    auth-user:
      chain:
        middlewares:
          - rate-limit-auth
          - google-auth-user

    auth-admin:
      chain:
        middlewares:
          - rate-limit-auth
          - google-auth-admin

  routers:
    # Catch-all for unknown subdomains (low priority)
    catchall:
      rule: "HostRegexp(`[a-z0-9-]+\\.jaw\\.dev`)"
      entrypoints:
        - websecure
      middlewares:
        - redirect-to-main
      service: dummy
      priority: 1
      tls: {}

  services:
    # Dummy service for redirects (never actually used)
    dummy:
      loadBalancer:
        servers:
          - url: "http://127.0.0.1"

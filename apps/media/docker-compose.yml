services:
  # VPN Container - provides HTTP proxy for qBittorrent torrent traffic
  gluetun:
    image: qmcgaw/gluetun:v3.39
    cap_add:
      - NET_ADMIN
    privileged: true
    env_file:
      - .enc.env
    environment:
      - TZ=America/Chicago
      - HTTPPROXY=on
    volumes:
      - gluetun-data:/gluetun
    networks:
      - vpn-internal
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # Torrent client - torrent traffic through VPN proxy
  # Configure in UI: Settings > Connection > Proxy > HTTP, gluetun:8888
  # Enable: "Use proxy for peer connections" + "Use proxy for hostname lookup"
  qbittorrent:
    image: linuxserver/qbittorrent:4.6.7
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
      - WEBUI_PORT=8085
    volumes:
      - qbittorrent-config:/config
      - /home/jaw/plex/downloads:/downloads
    networks:
      - traefik
      - vpn-internal
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.qbittorrent.rule=Host(`qbit.wajeht.com`)"
        - "traefik.http.routers.qbittorrent.entrypoints=websecure"
        - "traefik.http.routers.qbittorrent.tls.certresolver=cloudflare"
        - "traefik.http.services.qbittorrent.loadbalancer.server.port=8085"

  # Indexer manager
  prowlarr:
    image: linuxserver/prowlarr:1.28.2
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
    volumes:
      - prowlarr-config:/config
    networks:
      - traefik
      - media-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9696/ping"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.prowlarr.rule=Host(`prowlarr.wajeht.com`)"
        - "traefik.http.routers.prowlarr.entrypoints=websecure"
        - "traefik.http.routers.prowlarr.tls.certresolver=cloudflare"
        - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"

  # Movie management
  radarr:
    image: linuxserver/radarr:5.16.3
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
    volumes:
      - radarr-config:/config
      - /home/jaw/plex/downloads:/downloads
      - /home/jaw/plex/movies:/movies
    networks:
      - traefik
      - media-internal
      - vpn-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878/ping"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.radarr.rule=Host(`radarr.wajeht.com`)"
        - "traefik.http.routers.radarr.entrypoints=websecure"
        - "traefik.http.routers.radarr.tls.certresolver=cloudflare"
        - "traefik.http.services.radarr.loadbalancer.server.port=7878"

  # TV show management
  sonarr:
    image: linuxserver/sonarr:4.0.11
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
    volumes:
      - sonarr-config:/config
      - /home/jaw/plex/downloads:/downloads
      - /home/jaw/plex/tv:/tv
    networks:
      - traefik
      - media-internal
      - vpn-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/ping"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.sonarr.rule=Host(`sonarr.wajeht.com`)"
        - "traefik.http.routers.sonarr.entrypoints=websecure"
        - "traefik.http.routers.sonarr.tls.certresolver=cloudflare"
        - "traefik.http.services.sonarr.loadbalancer.server.port=8989"

  # Cloudflare bypass for indexers
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:v3.3.21
    environment:
      - TZ=America/Chicago
      - LOG_LEVEL=info
    networks:
      - media-internal
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  # Media server
  plex:
    image: linuxserver/plex:1.41.3
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
      - VERSION=docker
    env_file:
      - .enc.env
    volumes:
      - plex-config:/config
      - /home/jaw/plex/movies:/movies
      - /home/jaw/plex/tv:/tv
    networks:
      - traefik
    ports:
      - "32400:32400"
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.plex.rule=Host(`plex.wajeht.com`)"
        - "traefik.http.routers.plex.entrypoints=websecure"
        - "traefik.http.routers.plex.tls.certresolver=cloudflare"
        - "traefik.http.services.plex.loadbalancer.server.port=32400"

  # Plex stats & monitoring
  tautulli:
    image: linuxserver/tautulli:2.14.6
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
    volumes:
      - tautulli-config:/config
    networks:
      - traefik
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8181/status"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.tautulli.rule=Host(`tautulli.wajeht.com`)"
        - "traefik.http.routers.tautulli.entrypoints=websecure"
        - "traefik.http.routers.tautulli.tls.certresolver=cloudflare"
        - "traefik.http.services.tautulli.loadbalancer.server.port=8181"

  # Media request management
  overseerr:
    image: linuxserver/overseerr:1.33.2
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
    volumes:
      - overseerr-config:/config
    networks:
      - traefik
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5055/api/v1/status"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.overseerr.rule=Host(`requests.wajeht.com`)"
        - "traefik.http.routers.overseerr.entrypoints=websecure"
        - "traefik.http.routers.overseerr.tls.certresolver=cloudflare"
        - "traefik.http.services.overseerr.loadbalancer.server.port=5055"

volumes:
  gluetun-data:
  qbittorrent-config:
  prowlarr-config:
  radarr-config:
  sonarr-config:
  plex-config:
  tautulli-config:
  overseerr-config:

networks:
  traefik:
    external: true
  media-internal:
  vpn-internal:
    internal: true  # NO external internet access - forces VPN

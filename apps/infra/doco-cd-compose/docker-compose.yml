# Compose-mode deployer for apps/compose/ (plex, vpn-qbit)
# These apps need device access not supported by Swarm

services:
  doco-cd:
    image: ghcr.io/kimdre/doco-cd:0.62.0@sha256:13bae918ee72d1662e3283a0f422b9fab7d25acb3a87f673ea380ccead751a73
    container_name: doco-cd-compose
    environment:
      TZ: America/Chicago
      LOG_LEVEL: info
      MAX_DEPLOYMENT_LOOP_COUNT: "3"
      DOCKER_SWARM_FEATURES: "false"
      SOPS_AGE_KEY_FILE: /sops/age-key.txt
      GIT_ACCESS_TOKEN: ${GH_TOKEN}
      WEBHOOK_SECRET: ${WEBHOOK_SECRET}
      POLL_CONFIG: |
        - url: https://github.com/wajeht/home-ops.git
          reference: refs/heads/main
          interval: 60
          deployments:
            - working_dir: apps/compose
              auto_discover: true
              auto_discover_opts:
                delete: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /home/jaw/data/doco-cd-compose:/data
      - /home/jaw/.sops/age-key.txt:/sops/age-key.txt:ro
      - /home/jaw/.docker/config.json:/root/.docker/config.json:ro
    networks:
      - traefik
    # Traefik routing handled via traefik/dynamic.yml (swarm provider can't read compose labels)
    healthcheck:
      test: ["CMD", "/doco-cd", "healthcheck"]
      start_period: 15s
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

networks:
  traefik:
    external: true

# Swarm-mode deployer for apps/swarm/*
# Runs as compose container but deploys swarm stacks via DOCKER_SWARM_FEATURES=true

services:
  doco-cd:
    image: ghcr.io/kimdre/doco-cd:0.62.0@sha256:13bae918ee72d1662e3283a0f422b9fab7d25acb3a87f673ea380ccead751a73
    container_name: doco-cd
    depends_on:
      - apprise
    ports:
      - "9120:9120"
    environment:
      TZ: America/Chicago
      LOG_LEVEL: info
      MAX_DEPLOYMENT_LOOP_COUNT: "3"
      APPRISE_API_URL: http://apprise:8000/notify
      APPRISE_NOTIFY_LEVEL: success
      DOCKER_SWARM_FEATURES: "true"
      SOPS_AGE_KEY_FILE: /sops/age-key.txt
      GIT_ACCESS_TOKEN: ${GH_TOKEN}
      WEBHOOK_SECRET: ${WEBHOOK_SECRET}
      POLL_CONFIG: |
        - url: https://github.com/wajeht/home-ops.git
          reference: refs/heads/main
          interval: 60
          deployments:
            - working_dir: apps/swarm
              auto_discover: true
              auto_discover_opts:
                delete: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /home/jaw/data/doco-cd:/data
      - /home/jaw/.sops/age-key.txt:/sops/age-key.txt:ro
      - /home/jaw/.docker/config.json:/root/.docker/config.json:ro
    networks:
      - traefik
      - default
    # Traefik routing handled via traefik/dynamic.yml (swarm provider can't read compose labels)
    healthcheck:
      test: ["CMD", "/doco-cd", "healthcheck"]
      start_period: 15s
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  apprise:
    image: caronc/apprise:v1.3.1@sha256:6b112f8f174244f4a73b8e1254c9bde1fa562a6a428010aeaff1c18bc98d2713
    container_name: apprise
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/status"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

networks:
  traefik:
    external: true

services:
  renovate:
    image: ghcr.io/mend/renovate-ce:13.4.0
    container_name: renovate
    environment:
      MEND_RNV_ACCEPT_TOS: "y"
      MEND_RNV_PLATFORM: github
      MEND_RNV_GITHUB_APP_ID: "2825559"
      MEND_RNV_GITHUB_APP_KEY: ${MEND_RNV_GITHUB_APP_KEY}
      MEND_RNV_WEBHOOK_SECRET: ${MEND_RNV_WEBHOOK_SECRET}
      MEND_RNV_LICENSE_KEY: ${MEND_RNV_LICENSE_KEY}
      MEND_RNV_SQLITE_FILE_PATH: /data/renovate.db
      MEND_RNV_SERVER_PORT: "8080"
      GITHUB_COM_TOKEN: ${GITHUB_COM_TOKEN}
      RENOVATE_SECRETS: ${RENOVATE_SECRETS}
      NODE_OPTIONS: "--max-old-space-size=2048" # OOM on large repos (e.g. docker-cd) at 1536
      LOG_LEVEL: info
      MEND_RNV_CRON_JOB_SCHEDULER_ALL: "0 6,8,10 * * *" # midnight, 2am, 4am CST (UTC+6)
      RENOVATE_REPOSITORY_CACHE: enabled
      RENOVATE_OPTIMIZE_FOR_DISABLED: "true"
      RENOVATE_EXECUTION_TIMEOUT: "30"
      RENOVATE_CACHE_HARD_TTL_MINUTES: "20160"
      RENOVATE_ONBOARDING_CONFIG_FILE_NAME: ".github/renovate.json"
      MEND_RNV_AUTODISCOVER_FILTER: "wajeht/*"
    volumes:
      - /home/jaw/data/renovate:/data
    networks:
      - proxy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "3.0"
          memory: 3G
    labels:
      caddy: renovate.jaw.dev
      caddy.handle_0: /webhook
      caddy.handle_0.reverse_proxy: "{{upstreams 8080}}"
      caddy.handle_1: "*"
      caddy.handle_1.import: auth
      caddy.handle_1.reverse_proxy: "{{upstreams 8080}}"

networks:
  proxy:
    external: true

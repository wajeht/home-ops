# Dynamic config for non-swarm services (docker-compose)
http:
  middlewares:
    redirect-to-main:
      redirectRegex:
        regex: ".*"
        replacement: "https://jaw.dev"
        permanent: true

    authentik:
      forwardAuth:
        address: http://authentik_server:9000/outpost.goauthentik.io/auth/traefik
        trustForwardHeader: true
        authResponseHeaders:
          - X-authentik-username
          - X-authentik-groups
          - X-authentik-email
          - X-authentik-name
          - X-authentik-uid
          - X-authentik-jwt
          - X-authentik-meta-jwks
          - X-authentik-meta-outpost
          - X-authentik-meta-provider
          - X-authentik-meta-app
          - X-authentik-meta-version

  routers:
    # Catch-all for unknown subdomains (low priority)
    catchall:
      rule: "HostRegexp(`{subdomain:[a-z0-9-]+}.jaw.dev`)"
      entrypoints:
        - websecure
      middlewares:
        - redirect-to-main
      service: dummy
      priority: 1
      tls: {}

    qbittorrent:
      rule: "Host(`qbit.jaw.dev`)"
      entrypoints:
        - websecure
      service: qbittorrent
      middlewares:
        - authentik
      tls: {}

  services:
    # Dummy service for redirects (never actually used)
    dummy:
      loadBalancer:
        servers:
          - url: "http://127.0.0.1"

    qbittorrent:
      loadBalancer:
        servers:
          - url: "http://gluetun:8085"

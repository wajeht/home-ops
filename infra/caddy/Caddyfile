{
	email mail@jaw.dev
	admin :2019

	order authenticate before respond
	order authorize before basicauth

	servers {
		trusted_proxies static 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22
	}

	security {
		oauth identity provider google {
			realm google
			driver google
			client_id {env.GOOGLE_CLIENT_ID}
			client_secret {env.GOOGLE_CLIENT_SECRET}
			scopes openid email profile
			icon "Google" "lab la-google la-2x" "white" "#e53935" priority 100
		}

		authentication portal authportal {
			crypto default token lifetime 86400
			crypto key sign-verify {env.JWT_SECRET}
			cookie domain jaw.dev
			cookie path /
			cookie lifetime 86400
			cookie samesite lax
			enable source ip tracking
			enable identity provider google

			# Admin allowlist (set in infra/caddy/.env.sops).
			transform user {
				match email {env.AUTH_ADMIN_EMAIL_1}
				action add role authp/admin
				ui link "Logs" https://logs.jaw.dev icon "las la-file-alt"
				ui link "Caddy" https://caddy.jaw.dev icon "las la-cog"
			}

			# User allowlist (set in infra/caddy/.env.sops).
			transform user {
				match email {env.AUTH_USER_EMAIL_1}
				action add role authp/user
			}
			transform user {
				match email {env.AUTH_USER_EMAIL_2}
				action add role authp/user
			}
			transform user {
				match email {env.AUTH_USER_EMAIL_3}
				action add role authp/user
			}
			transform user {
				match email {env.AUTH_USER_EMAIL_4}
				action add role authp/user
			}
			transform user {
				match email {env.AUTH_USER_EMAIL_5}
				action add role authp/user
			}
			transform user {
				match email {env.AUTH_USER_EMAIL_6}
				action add role authp/user
			}
			transform user {
				match email {env.AUTH_USER_EMAIL_7}
				action add role authp/user
			}
			transform user {
				match email {env.AUTH_USER_EMAIL_8}
				action add role authp/user
			}
			transform user {
				match email {env.AUTH_USER_EMAIL_9}
				action add role authp/user
			}
			transform user {
				match email {env.AUTH_USER_EMAIL_10}
				action add role authp/user
			}

			# Drop guest role after allowlist mapping succeeds.
			transform user {
				regex match any role "^authp/guest$"
				action drop matched role
			}

			ui {
				theme basic
				links {
					"Home" https://home.jaw.dev/ icon "las la-home"
					"Plex" https://plex.jaw.dev/ icon "las la-photo-video"
					"Seerr" https://seerr.jaw.dev/ icon "las la-tv"
				}
				custom css path /etc/caddy/ui/custom.css
				custom js path /etc/caddy/ui/custom.js
			}
		}

		authorization policy authpolicy {
			set auth url https://auth.jaw.dev/auth
			crypto key verify {env.JWT_SECRET}
			allow roles authp/user authp/admin
			validate source address
			inject headers with claims
			inject header "X-Auth-Email" from email
			inject header "X-Auth-Name" from name
			inject header "X-Auth-Roles" from roles
			enable strip token
		}

		authorization policy authpolicy_admin {
			set auth url https://auth.jaw.dev/auth
			crypto key verify {env.JWT_SECRET}
			allow roles authp/admin
			validate source address
			inject headers with claims
			inject header "X-Auth-Email" from email
			inject header "X-Auth-Name" from name
			inject header "X-Auth-Roles" from roles
			enable strip token
		}
	}
}

auth.jaw.dev {
	# Optional: add endpoint rate limiting once the custom image includes
	# github.com/mholt/caddy-ratelimit in docker-cd-caddy.
	authenticate with authportal
}

(auth) {
	import defaults
	authorize with authpolicy
}

(auth-admin) {
	import defaults
	authorize with authpolicy_admin
}

(public) {
	import defaults
}

(error-pages) {
	handle_errors {
		@unauthorized expression `{http.error.status_code} == 401`
		handle @unauthorized {
			respond "Sign in required. Your session is missing or expired." 401
		}

		@forbidden expression `{http.error.status_code} == 403`
		handle @forbidden {
			respond "Access denied. This account is not allowed for this service." 403
		}

		@upstream expression `{http.error.status_code} >= 500`
		handle @upstream {
			respond "Service unavailable. The upstream service is currently unavailable." 502
		}
	}
}

(defaults) {
	encode zstd gzip
	import error-pages
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "geolocation=(), microphone=(), camera=()"
		-Server
	}
}

(cf-tls) {
	tls {
		dns cloudflare {env.CF_DNS_API_TOKEN}
	}
}

http://*.jaw.dev {
	redir https://jaw.dev{uri} permanent
}

https://*.jaw.dev {
	tls {
		dns cloudflare {env.CF_DNS_API_TOKEN}
	}
	redir https://jaw.dev{uri} permanent
}

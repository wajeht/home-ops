services:
  caddy:
    # Built/published by https://github.com/wajeht/docker-cd-caddy
    # Pinned to an immutable image tag for repeatable deploys.
    image: ghcr.io/wajeht/docker-cd-caddy:sha-1e84728
    command: ["caddy", "docker-proxy"]
    ports:
      - "80:80"
      - "443:443"
    environment:
      TZ: America/Chicago
      CADDY_INGRESS_NETWORKS: proxy
      CADDY_DOCKER_CADDYFILE_PATH: /etc/caddy/Caddyfile
      CF_DNS_API_TOKEN: ${CF_DNS_API_TOKEN}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      JWT_SECRET: ${JWT_SECRET}
      AUTH_ADMIN_EMAIL_1: ${AUTH_ADMIN_EMAIL_1}
      AUTH_USER_EMAIL_1: ${AUTH_USER_EMAIL_1}
      AUTH_USER_EMAIL_2: ${AUTH_USER_EMAIL_2}
      AUTH_USER_EMAIL_3: ${AUTH_USER_EMAIL_3}
      AUTH_USER_EMAIL_4: ${AUTH_USER_EMAIL_4}
      AUTH_USER_EMAIL_5: ${AUTH_USER_EMAIL_5}
      AUTH_USER_EMAIL_6: ${AUTH_USER_EMAIL_6}
      AUTH_USER_EMAIL_7: ${AUTH_USER_EMAIL_7}
      AUTH_USER_EMAIL_8: ${AUTH_USER_EMAIL_8}
      AUTH_USER_EMAIL_9: ${AUTH_USER_EMAIL_9}
      AUTH_USER_EMAIL_10: ${AUTH_USER_EMAIL_10}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /home/jaw/data/caddy/data:/data
      - /home/jaw/data/caddy/config:/config
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./ui:/etc/caddy/ui:ro
    networks:
      - proxy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:2019/config/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
    labels:
      caddy: caddy.jaw.dev
      caddy.import: auth-admin
      caddy.reverse_proxy: 127.0.0.1:2019
      caddy.reverse_proxy.header_up: Host localhost:2019

networks:
  proxy:
    external: true

services:
  doco-cd:
    image: ghcr.io/kimdre/doco-cd:0.60.0
    container_name: doco-cd
    restart: unless-stopped
    depends_on:
      - apprise
    ports:
      - "9120:9120"
    environment:
      TZ: America/Chicago
      LOG_LEVEL: info
      GIT_ACCESS_TOKEN_FILE: /run/secrets/git_token
      WEBHOOK_SECRET_FILE: /run/secrets/webhook_secret
      API_SECRET_FILE: /run/secrets/api_secret
      MAX_DEPLOYMENT_LOOP_COUNT: "3"
      APPRISE_API_URL: http://apprise:8000/notify
      APPRISE_NOTIFY_URLS_FILE: /run/secrets/apprise_url
      APPRISE_NOTIFY_LEVEL: success
      SOPS_AGE_KEY_FILE: /run/secrets/sops_age_key
      POLL_CONFIG: |
        - url: https://github.com/wajeht/home-ops.git
          reference: refs/heads/main
          interval: 0
    secrets:
      - git_token
      - webhook_secret
      - api_secret
      - apprise_url
      - sops_age_key
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - doco-data:/data
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.doco-cd.rule=Host(`doco.wajeht.com`)"
      - "traefik.http.routers.doco-cd.entrypoints=websecure"
      - "traefik.http.routers.doco-cd.tls=true"
      - "traefik.http.routers.doco-cd.tls.certresolver=letsencrypt"
      - "traefik.http.services.doco-cd.loadbalancer.server.port=80"
    healthcheck:
      test: ["CMD", "/doco-cd", "healthcheck"]
      start_period: 15s
      interval: 30s
      timeout: 5s
      retries: 3

  apprise:
    image: caronc/apprise:v1.3.1
    container_name: apprise
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/status"]
      interval: 30s
      timeout: 5s
      retries: 3

secrets:
  git_token:
    file: /root/.secrets/git-token
  webhook_secret:
    file: /root/.secrets/webhook-secret
  api_secret:
    file: /root/.secrets/api-secret
  apprise_url:
    file: /root/.secrets/apprise-url
  sops_age_key:
    file: /root/.sops/age-key.txt

volumes:
  doco-data:

networks:
  traefik:
    external: true

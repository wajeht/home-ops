services:
  doco-cd:
    image: ghcr.io/kimdre/doco-cd:0.60.0
    depends_on:
      - apprise
    ports:
      - "9120:9120"
    environment:
      TZ: America/Chicago
      LOG_LEVEL: info
      GIT_ACCESS_TOKEN_FILE: /run/secrets/git_token
      WEBHOOK_SECRET_FILE: /run/secrets/webhook_secret
      API_SECRET_FILE: /run/secrets/api_secret
      MAX_DEPLOYMENT_LOOP_COUNT: "3"
      APPRISE_API_URL: http://apprise:8000/notify
      APPRISE_NOTIFY_URLS_FILE: /run/secrets/apprise_url
      APPRISE_NOTIFY_LEVEL: success
      SOPS_AGE_KEY_FILE: /run/secrets/sops_age_key
      POLL_CONFIG: |
        - url: https://github.com/wajeht/home-ops.git
          reference: refs/heads/main
          interval: 0
    secrets:
      - git_token
      - webhook_secret
      - api_secret
      - apprise_url
      - sops_age_key
      - source: docker_config
        target: /root/.docker/config.json
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - doco-data:/data
    networks:
      - traefik
      - default
    healthcheck:
      test: ["CMD", "/doco-cd", "healthcheck"]
      start_period: 15s
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      replicas: 1
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.doco-cd.rule=Host(`doco.wajeht.com`)"
        - "traefik.http.routers.doco-cd.entrypoints=websecure"
        - "traefik.http.routers.doco-cd.tls=true"
        - "traefik.http.routers.doco-cd.tls.certresolver=letsencrypt"
        - "traefik.http.services.doco-cd.loadbalancer.server.port=80"
      placement:
        constraints:
          - node.role == manager
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      rollback_config:
        parallelism: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  apprise:
    image: caronc/apprise:v1.3.1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/status"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      rollback_config:
        parallelism: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

secrets:
  git_token:
    external: true
  webhook_secret:
    external: true
  api_secret:
    external: true
  apprise_url:
    external: true
  sops_age_key:
    external: true
  docker_config:
    external: true

volumes:
  doco-data:

networks:
  traefik:
    external: true
